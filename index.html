<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Portal Pelajar - Aduan SEMSIRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { border:none; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .alert-success { display:none; }
  </style>
</head>
<body>
<div class="container py-5">
  <!-- Language Selector -->
  <div class="text-end mb-3">
    <select id="languageSwitcher" class="form-select w-auto d-inline">
      <option value="ms">🇲🇾 BM</option>
      <option value="en">🇬🇧 EN</option>
      <option value="zh">🇨🇳 中文</option>
    </select>
  </div>

  <h2 id="title" class="text-center mb-4">📢 Portal Aduan Pelajar SEMSIRA</h2>

  <!-- Masukkan Nama & Kelas -->
  <div class="card p-4 mb-4">
    <h4>Maklumat Pelajar</h4>
    <form id="studentInfoForm">
      <div class="mb-3">
        <label class="form-label">Nama Pelajar</label>
        <input type="text" id="studentName" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Kelas</label>
        <input type="text" id="studentClass" class="form-control" required>
      </div>
      <button type="submit" class="btn btn-primary">Simpan</button>
    </form>
  </div>

  <!-- Hantar Aduan -->
  <div class="card p-4 mb-4" id="complaintCard" style="display:none;">
    <h4 id="sendComplaintTitle">Hantar Aduan</h4>
    <form id="aduanForm">
      <div class="mb-3">
        <label id="labelComplaint" class="form-label">Aduan</label>
        <textarea id="aduan" class="form-control" rows="3" required></textarea>
      </div>
      <button id="btnSubmit" type="submit" class="btn btn-primary">Hantar Aduan</button>
    </form>
    <div id="successMsg" class="alert alert-success mt-3"></div>
  </div>

  <!-- Aduan Pelajar -->
  <div class="card p-4 mb-4" id="myAduanCard" style="display:none;">
    <h4>Aduan Anda</h4>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th><th>Aduan</th><th>Status</th><th>Tarikh</th><th>Nota Admin</th>
        </tr>
      </thead>
      <tbody id="studentComplaints"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCkStR_IPVoyw83P9M3Xm0QayvNmHwsjz0",
    authDomain: "aduan-semsira.firebaseapp.com",
    projectId: "aduan-semsira",
    storageBucket: "aduan-semsira.appspot.com",
    messagingSenderId: "900897970331",
    appId: "1:900897970331:web:5bea8305599c97a0e30e3e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let studentName = "";
  let studentClass = "";

  const studentInfoForm = document.getElementById("studentInfoForm");
  const complaintCard = document.getElementById("complaintCard");
  const myAduanCard = document.getElementById("myAduanCard");

  studentInfoForm.addEventListener("submit", (e)=>{
    e.preventDefault();
    studentName = document.getElementById("studentName").value.trim().toUpperCase();
    studentClass = document.getElementById("studentClass").value.trim().toUpperCase();
    complaintCard.style.display = "block";
    myAduanCard.style.display = "block";
    loadStudentComplaints();
  });

  const aduanForm = document.getElementById("aduanForm");
  aduanForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const aduanText = document.getElementById("aduan").value.trim();
    if(!aduanText) return;
    try{
      await addDoc(collection(db,"aduan"),{
        nama: studentName,
        kelas: studentClass,
        aduan: aduanText,
        status: "Dalam Proses",
        tarikh: new Date().toLocaleString(),
        nota: ""
      });
      document.getElementById("aduanForm").reset();
      document.getElementById("successMsg").style.display="block";
      document.getElementById("successMsg").innerText="✅ Aduan berjaya dihantar!";
    } catch(err){
      alert("❌ Gagal hantar aduan: "+err.message);
    }
  });

  function loadStudentComplaints(){
    const q = query(collection(db,"aduan"));
    onSnapshot(q, (snapshot)=>{
      const tbody = document.getElementById("studentComplaints");
      tbody.innerHTML="";
      snapshot.forEach(docSnap=>{
        const a = docSnap.data();
        if(a.nama.toUpperCase() === studentName && a.kelas.toUpperCase() === studentClass){
          tbody.innerHTML += `<tr>
            <td>${docSnap.id}</td>
            <td>${a.aduan}</td>
            <td>${a.status}</td>
            <td>${a.tarikh}</td>
            <td>${a.nota||"-"}</td>
          </tr>`;
          // alert bila admin update
          if(!a._notified){
            alert(`Aduan ${docSnap.id} dikemaskini: ${a.status}`);
            docSnap.ref.update({_notified:true}).catch(()=>{});
          }
        }
      });
    });
  }
</script>
</body>
</html>


